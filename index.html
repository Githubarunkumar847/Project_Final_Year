<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Membrane Performance Analysis</title>

<!-- SQL.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    margin: 0;
    font-family: "Segoe UI", Roboto, Arial, sans-serif;
    background: #f4f6f8;
    color: #333;
}

header {
    background: #0b5ed7;
    color: white;
    padding: 16px 32px;
    font-size: 22px;
    font-weight: 600;
}

.container {
    display: grid;
    grid-template-columns: 260px 1fr;
    height: calc(100vh - 64px);
}

.sidebar {
    background: #ffffff;
    border-right: 1px solid #ddd;
    padding: 20px;
}

.sidebar h3 {
    margin-top: 0;
    font-size: 16px;
    color: #0b5ed7;
}

.sidebar button {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    background: #e9f1ff;
    border: 1px solid #cfe0ff;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
}

.sidebar button:hover {
    background: #d6e6ff;
}

.main {
    padding: 24px;
    display: flex;
    flex-direction: column;
}

textarea {
    width: 100%;
    height: 120px;
    font-family: Consolas, monospace;
    font-size: 14px;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #ccc;
}

.run-btn {
    align-self: flex-end;
    margin-top: 10px;
    padding: 10px 18px;
    background: #0b5ed7;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}

.result {
    margin-top: 20px;
}

table {
    width: 100%;
    border-collapse: collapse;
    background: white;
}

th, td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    text-align: center;
}

th {
    background: #f1f3f5;
}

.charts {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-top: 30px;
}
</style>
</head>

<body>

<header>
Electrospun PAN/MXene/TiO₂ Membrane – SQL & Visual Analysis
</header>

<div class="container">

<div class="sidebar">
    <h3>Quick Analysis</h3>
    <button onclick="setQuery(showAll)">Show Full Dataset</button>
    <button onclick="setQuery(bestSolvent)">Best Solvent</button>
    <button onclick="setQuery(viscosityEffect)">Flux vs Viscosity</button>
    <button onclick="setQuery(systemComparison)">Immiscible vs Emulsion</button>
    <button onclick="setQuery(solventRanking)">Solvent Ranking</button>
</div>

<div class="main">

<textarea id="query"></textarea>
<button class="run-btn" onclick="runQuery()">Run Query</button>

<div class="result" id="output"></div>

<div class="charts">
    <canvas id="chart1"></canvas>
    <canvas id="chart2"></canvas>
</div>

</div>
</div>

<script>
let db, chart1, chart2;

/* ---------- Queries ---------- */

const showAll = `SELECT * FROM performance;`;

const bestSolvent = `
SELECT solvent, AVG(flux_lmh) avg_flux, AVG(efficiency_pct) avg_eff
FROM performance GROUP BY solvent;
`;

const viscosityEffect = `
SELECT viscosity_cp, AVG(flux_lmh) avg_flux
FROM performance GROUP BY viscosity_cp ORDER BY viscosity_cp;
`;

const systemComparison = `
SELECT system_type, AVG(flux_lmh) avg_flux
FROM performance GROUP BY system_type;
`;

const solventRanking = `
SELECT solvent,
AVG((flux_lmh/3000.0 + efficiency_pct/99.0)/2) score
FROM performance GROUP BY solvent ORDER BY score DESC;
`;

function setQuery(q){ document.getElementById("query").value = q; }

/* ---------- CSV Loader ---------- */

async function loadCSV(){
    const res = await fetch("performance.csv");
    const text = await res.text();
    const rows = text.trim().split("\n").slice(1);

    rows.forEach(r=>{
        const v = r.split(",");
        db.run(`INSERT INTO performance VALUES (?,?,?,?,?,?)`, v);
    });
}

/* ---------- SQL Init ---------- */

initSqlJs({
 locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${f}`
}).then(async SQL=>{
    db = new SQL.Database();
    db.run(`
        CREATE TABLE performance (
            solvent TEXT,
            system_type TEXT,
            oil_type TEXT,
            viscosity_cp REAL,
            flux_lmh REAL,
            efficiency_pct REAL
        );
    `);
    await loadCSV();
    setQuery(showAll);
});

/* ---------- Run Query + Charts ---------- */

function runQuery(){
    const q = document.getElementById("query").value;
    const r = db.exec(q);
    if(!r.length){ output.innerHTML="No results"; return; }

    const cols = r[0].columns;
    const vals = r[0].values;

    let html="<table><tr>";
    cols.forEach(c=>html+=`<th>${c}</th>`);
    html+="</tr>";
    vals.forEach(row=>{
        html+="<tr>";
        row.forEach(v=>html+=`<td>${v}</td>`);
        html+="</tr>";
    });
    html+="</table>";
    output.innerHTML=html;

    drawCharts(cols, vals);
}

/* ---------- Charts ---------- */

function drawCharts(cols, data){
    if(chart1) chart1.destroy();
    if(chart2) chart2.destroy();

    const labels = data.map(r=>r[0]);
    const values = data.map(r=>r[1]);

    chart1 = new Chart(document.getElementById("chart1"),{
        type:"bar",
        data:{ labels, datasets:[{ label: cols[1], data: values }] }
    });

    chart2 = new Chart(document.getElementById("chart2"),{
        type:"line",
        data:{ labels, datasets:[{ label: cols[1], data: values }] }
    });
}
</script>

</body>
</html>
